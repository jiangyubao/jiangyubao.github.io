<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <meta charset="utf-8">
    <title>屏幕计算</title>
    <link href="http://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap-theme.min.css"
          rel="stylesheet"/>
    <link href="http://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css"
          rel="stylesheet"/>
    <script src="http://apps.bdimg.com/libs/angular.js/1.3.9/angular.min.js"></script>
    <style>
        form .ng-invalid.ng-dirty {
            background-color: lightpink;
        }

        form .ng-valid.ng-dirty {
            background-color: lightgreen;
        }
    </style>
    <script type="application/javascript">
        angular.module('myApp', []).controller('MyCtrl',
                function ($scope) {
                    $scope.model = {};
                    $scope.model.points = [];
                    $scope.model.results = [];
                    for (var i = 0; i < 100; i++) {
                        $scope.model.points.push({x: i, y: i});
                        $scope.model.results.push({bx: 0, x: 0, by: 0, y: 0})
                    }
                    $scope.cal = function (index) {
                        var x = parseInt($scope.model.points[index].x);
                        var y = parseInt($scope.model.points[index].y);
                        if (isNaN(x) || !(x >= 0 && x <= 300)) {
                            $scope.model.results[index].bx = -1;
                            $scope.model.results[index].x = -1;
                        } else {
                            $scope.model.results[index].bx = parseInt(x / 40);
                            $scope.model.results[index].x = Math.round(128 * (x % 40) / 40.64);
                        }
                        if (isNaN(y) || !(y >= 0 && y <= 300)) {
                            $scope.model.results[index].by = -1;
                            $scope.model.results[index].y = -1;
                        } else {
                            $scope.model.results[index].by = parseInt(y / 30);
                            $scope.model.results[index].y = Math.round(128 * (y % 30) / 30.48);
                        }
                    };
                    for (i = 0; i < 10; i++) {
                        $scope.cal(i);
                    }
                }).filter("hex", function ($log) {
                    return function (v) {
                        if (v == -1) {
                            return '##';
                        }
                        var vv = v.toString(16);
                        return vv.length == 1 ? '0' + vv : vv;
                    };
                }).directive('numberRange', function () {
                    return {
                        require: 'ngModel',
                        link: function (scope, ele, attrs, c) {
                            scope.$watch(attrs.ngModel, function () {
                                var range = attrs['numberRange'];
                                var a = JSON.parse(range);
                                var val = parseInt(ele.val());
                                var result = angular.isNumber(val) && angular.isArray(a)
                                        && a.length == 2 && angular.isNumber(a[0]) && angular.isNumber(a[1])
                                        && val >= a[0] && val <= a[1];
                                c.$setValidity('numberRange', result);
                            });
                        }
                    }
                });
    </script>
</head>
<body ng-controller="MyCtrl">
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">批量换算</h3>
    </div>
    <div class="panel-body">
        <form novalidate name="tableForm">
            <table class="table table-striped table-bordered table-hover table-condensed">
                <thead>
                <tr class="success">
                    <th>X(单位：mm)</th>
                    <th>Y(单位：mm)</th>
                    <th>编码(Y,X)</th>
                </tr>
                </thead>
                <tbody ng-form name="configForm" ng-repeat="point in model.points">
                <tr>
                    <td>
                        <input type="text" class="form-control" name="x"
                               number-range="[0,300]"
                               ng-model="point.x"
                               ng-change="cal($index)"/>
                        <option ng-repeat="value in point.values">{{value}}</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control" name="y" required
                               ng-model="point.y"
                               ng-change="cal($index)"/></td>
                    <td>
                        {{model.results[$index].by|hex}}{{model.results[$index].y|hex}},{{model.results[$index].bx|hex}}{{model.results[$index].x|hex}}
                    </td>
                </tr>
                </tbody>
            </table>
        </form>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">备注说明</h3>
    </div>
    <div class="panel-body">
        <ol>
            <li>
                坐标参数：Y轴走向：从上到下；X轴走向：从左到右；开始位置：左上。
            </li>
            <li>
                数据格式：5个字节，分别是：动作值(0x81按下，0x80抬起)；Y区值(0x00-0x05)；Y区内值(0x00-0x7F)；X区值(0x00-0x05)；X区内值(0x00-0x7F)。
            </li>

            <li>
                屏幕参数：分辨率：1024x768；长宽比率：4:3；理论屏幕大小：240mmx180mm，实际屏幕大小：243.84mmx182.88mm（即：12英寸）；分6x6区，每区分128x128区内值。
            </li>
            <li>
                测量工具：<a href="screen.pdf">标准二维毫米尺 </a>，使用A4不干胶打印纸打印。
            </li>
        </ol>
    </div>
</div>
</body>
</html>
